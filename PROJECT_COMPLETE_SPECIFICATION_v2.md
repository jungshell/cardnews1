## 충남콘텐츠진흥원 카드뉴스 자동화 시스템 - 개선 명세서 (v2)

이 문서는 기존 `PROJECT_COMPLETE_SPECIFICATION.md`를 바탕으로,

- **완전 무료 서비스만 사용**
- **초보자(비개발자 포함)도 개발·운영·관리가 쉬운 구조**
- **최대한 효율적으로 API/리소스를 사용하는 구조**

를 목표로 재정리·개선한 버전입니다.  
원본 명세의 번호 체계를 유지하면서, 사용자가 선택한 섹션(1.1, 1.2 / 2–3 전체 / 4.1, 4.3 / 5–12 전체 / 13.3)에 개선 사항을 반영했습니다.

---

## 1. 프로젝트 개요

### 1.1 목적 (개선 반영)

충남콘텐츠진흥원 관련 뉴스 기사를 **완전 자동/반자동으로 수집**하고,  
무료 AI를 활용해 **카드뉴스용 텍스트·이미지 자료를 자동 생성/정리**하여  
**초보자도 쉽게 운영할 수 있는 웹 도구(Streamlit 기반)**를 만드는 것이 목적입니다.

- **비용 정책**
  - 상업 요금제가 아닌, **각 서비스의 무료 티어 범위 내**에서만 동작
  - 무료 쿼터를 넘지 않도록 **쿼터 관리 + 캐싱 + TEST_MODE**로 방어
- **사용자 수준 가정**
  - Python / Git / 서버 배포 경험이 거의 없는 초보자
  - 클릭 위주의 UI, 한글 도움말, 자동 설정 점검 등으로 진입장벽 최소화

### 1.2 주요 기능 (개선 반영)

- **자동 뉴스 수집**
  - 네이버 뉴스 Open API를 이용한 실시간/예약 뉴스 검색
  - 중복 제거 + 관련도 점수로 **핵심 기사만 선별**
- **AI 기반 요약 (무료 Gemini)**
  - Google Gemini API 무료 티어 사용
  - 기사 1건당 **350–450자 한글 요약** 생성
  - 이미 요약이 있으면 **캐시를 재사용**하여 쿼터 절약
- **카드뉴스 문구 자동 생성**
  - Gemini로 **8장 카드뉴스 스크립트 자동 생성**
  - TEST_MODE에서 **직접 텍스트 수정 가능 (초보자 편집 지원)**
  - 형식: `TYPE=... | HEAD=... | BODY=... | IMAGE_KEY=...`
- **이미지 자료 자동 준비**
  - Iconify / Material Icons 무료 API로 **관련 아이콘 자동 검색·다운로드**
  - 카드별 **AI 이미지 프롬프트 자동 생성** (Bing Copilot, 나노바나나, ChatGPT 등에 바로 사용)
  - Canva 작업 가이드 제공 (디자인 경험 없는 사용자 대응)
- **쿼터/캐시 관리**
  - 여러 Gemini 키를 순환 사용
  - `gemini_quota.json` + 간단 캐시(`cache/`)로 **불필요한 재생성 최소화**
- **기록 관리**
  - 크롤링 기록, 배포 기록, 오류 기록을 JSON 파일로 저장
  - 초보자도 파일을 열어 현재 상태를 쉽게 확인 가능
- **알림 기능 (선택)**
  - Slack Webhook 무료 티어로 일일 추천 기사 전송
  - 알림 비사용 시에도 시스템은 정상 동작

---

## 2. 기술 스택 및 아키텍처 (개선 반영)

### 2.1 기술 스택

```text
Python 3.11 이상 (안정 버전 권장)
├── Streamlit                # 웹 UI (무료)
├── Google Gemini API        # AI 텍스트 생성 (무료 티어)
├── Naver News Open API      # 뉴스 검색 (무료)
├── Iconify API              # 벡터 아이콘 검색/다운로드 (무료, 키 불필요)
├── Material Icons           # Google Fonts 아이콘 (무료)
├── python-dotenv            # 환경 변수 관리
├── requests                 # HTTP 요청
├── schedule                 # 배치 스케줄링 (Railway 또는 로컬 cron 대체)
├── (선택) gspread           # Google Sheets 연동
└── (선택) sqlite3           # 경량 DB (표준 라이브러리, 설치 불필요)
```

> 변경점
> - Python 버전을 **3.13 → 3.11 이상**으로 완화 (패키지 호환성, 초보자 설치 편의성)
> - DB는 여전히 JSON 파일을 기본으로 사용하되, 필요 시 **표준 라이브러리 sqlite3**를 옵션으로 제안 (완전 무료)

### 2.2 프로젝트 구조 (개선 반영)

```text
cardnews_3/
├── app.py                        # 메인 Streamlit 앱
├── daily_fetch.py                # 일일 자동 크롤링 스크립트
├── daily_fetch_scheduler.py      # Railway/로컬 스케줄러
├── history_manager.py            # 기록 관리 모듈
├── cache_manager.py              # 요약/카드뉴스 캐싱 모듈 (신규)
├── setup_checker.py              # 환경/설정 자동 점검 모듈 (신규)
├── google_sheets_manager.py      # 구글 시트 연동 모듈 (선택)
├── requirements.txt              # Python 의존성
├── .env                          # 환경 변수 (Git 커밋 금지)
├── Procfile                      # Railway 배포 설정
├── data/
│   ├── daily_recommendations.json  # 자동 추천 기사
│   ├── gemini_quota.json           # Gemini API 쿼터 관리
│   ├── history.json                # 기록 데이터
│   └── error_log.json              # 주요 에러 로그 (신규, 단순 구조)
├── cache/                       # 기사/카드뉴스 캐시 (신규)
├── fonts/                       # 한글 폰트
└── outputs/                     # 생성된 파일 저장 (선택)
```

### 2.3 아키텍처 흐름 (개선 반영)

```text
[사용자]
  ↓
[Streamlit UI (app.py)]
  ├─ 시작 전 자동 설정 점검 (setup_checker)
  │   └─ 필수 환경변수/폴더/파일 존재 여부를 UI로 안내
  │
  ├─ 뉴스 검색 / 자동 추천
  │   └─ Naver News API
  │
  ├─ 요약 생성
  │   ├─ cache_manager 에서 기존 요약 캐시 조회
  │   └─ 필요 시 Gemini API 호출 + 쿼터/캐시 갱신
  │
  ├─ 카드뉴스 문구 생성
  │   ├─ cache_manager 캐시 조회
  │   └─ 필요 시 Gemini API 호출 + 캐시 저장
  │
  ├─ 이미지 자료 준비
  │   └─ Iconify API + Material Icons (SVG 다운로드 + 프롬프트 생성)
  │
  └─ 결과 표시 및 다운로드
      ├─ 진행상황/상태 표시 (progress bar + status text)
      └─ 통계/쿼터 현황/최근 에러 간단 대시보드
```

---

## 3. 핵심 기능 및 워크플로우 (개선 반영)

### 3.1 메인 워크플로우

#### 3.1.1 "오늘의 자동 추천 기사" 탭 (개선 포인트 포함)

```text
1. 사용자가 "🔄 지금 크롤링" 버튼 클릭
   ↓
2. setup_checker 가 필수 설정을 자동 점검
   - 누락된 환경변수, 없는 폴더 등을 한글로 안내
   - 문제가 있으면 다음 단계로 진행하지 않고 해결 방법 표시
   ↓
3. daily_recommendations.json 파일에서 기사 목록 로드
   (또는 daily_fetch.py가 이미 실행되어 저장된 기사 사용)
   ↓
4. remove_duplicate_articles() 로 중복 기사 제거
   + calculate_relevance_score() 로 관련도 점수 계산
   ↓
5. 기사 목록 표시 (제목, 설명, 링크, 관련도 점수)
   ↓
6. 사용자가 기사 선택
   ↓
7. "원문 요약 생성" 버튼 클릭
   → cache_manager.get_summary(article_id) 조회
     - 캐시 존재 & 길이 충분하면 Gemini 호출 없이 재사용
   → 없을 경우 summarize_with_gemini() 호출
     - Gemini API 무료 티어 사용, 쿼터/키 자동 관리
   → 요약 결과 표시 (요약 길이, 생성 시간 등 메타 정보 함께 표시)
   ↓
8. "카드뉴스 문구 생성" 버튼 클릭
   → cache_manager.get_card_script(article_id) 조회
   → 없을 경우 generate_cardnews_with_gemini() 호출
   → TEST_MODE일 때는 text_area로 문구 직접 편집 가능
   ↓
9. "카드뉴스 이미지 자료 준비" 버튼 클릭
   → parse_card_script()로 카드 파싱
   → 각 카드의 IMAGE_KEY로 Iconify/Material Icons 검색
   → SVG 파일 다운로드 (네트워크 오류 시 재시도 1–2회)
   → build_card_image_prompt()로 AI 이미지 생성 프롬프트 생성
   → ZIP 파일 생성
   → 결과 표시 및 다운로드 제공
   ↓
10. 전체 과정 동안 상단/사이드바에 진행률 바 + 현재 단계 텍스트 표시
```

#### 3.1.2 "실시간 뉴스 검색" 탭

기본 흐름은 기존과 동일하되, **캐싱·진행상황 표시·설정 점검**이 추가됩니다.

```text
1. 사용자가 검색어 입력 및 "뉴스 검색" 버튼 클릭
   ↓
2. setup_checker 에서 필수 설정 확인 (처음 1회 실행 시 특히 중요)
   ↓
3. search_naver_news() 호출
   → Naver News Open API로 검색
   → 결과 반환
   ↓
4. 중복 제거 + 관련도 점수 계산 후 기사 목록 표시
   ↓
5. 이후는 "오늘의 자동 추천 기사"와 동일 (요약 → 카드뉴스 → 이미지 자료)
```

### 3.2 주요 함수 및 역할 (핵심 로직은 유지, 캐시/초보자 지원 추가)

- **`search_naver_news(keyword, display=50)`**
  - 네이버 뉴스 검색
- **`summarize_with_gemini(news_content, news_title, max_retries=2)`**
  - Gemini 요약 생성 (캐시 미존재 시에만 호출)
- **`generate_cardnews_with_gemini(news_content, news_title)`**
  - 8장 카드뉴스 스크립트 생성 (캐시 미존재 시에만 호출)
- **`parse_card_script(script: str)`**
  - 카드별 구조로 파싱
- **`search_iconify_icons(query, limit=3)` / `search_material_icons(query, limit=3)`**
  - 관련 아이콘 검색
- **`download_svg(url, filename)` / `create_images_zip(images, zip_filename)`**
  - SVG 다운로드 및 ZIP 생성
- **`build_card_image_prompt(card)`**
  - 카드별 AI 이미지 프롬프트 생성
- **신규: `get_cached_summary`, `save_cached_summary`, `get_cached_script`, `save_cached_script` (cache_manager)**
  - 기사 URL 또는 해시를 key로 캐시 관리
- **신규: `run_setup_check()` (setup_checker)**
  - 필수 환경변수/폴더/파일 유무 점검 후, Streamlit에 한글 안내 메시지 출력

---

## 4. API 통합 및 쿼터 관리

### 4.1 Gemini API 쿼터 관리 시스템 (개선 반영)

기존 로직에 **“캐시 우선 사용” + “초보자용 상태 표시”**를 추가합니다.

- `.env`에서 최대 4개의 키를 읽어와 리스트로 관리 (`GEMINI_API_KEYS`)
- `data/gemini_quota.json`에 일자별 사용량·경고·초과 상태 저장
- **캐시 존재 시에는 쿼터를 아예 사용하지 않도록 설계**
- Streamlit 사이드바에 키별 남은 횟수, 경고/초과 상태를 색상으로 표시

추가 권장사항:

- 하루 사용량이 경고 임계치(예: 15회)에 도달하면
  - 상단에 **“오늘은 여기까지만 사용하는 것을 추천”** 같은 한글 안내를 띄워 초보자가 안심하고 사용하도록 유도
- TEST_MODE에서는
  - 기본적으로 1기사, 1요약, 1카드뉴스만 생성하도록 제한 (이미 명세에 있음)
  - 쿼터 파일에 “test_mode” 플래그를 기록해 실제 운영 통계와 구분

### 4.3 Iconify API (기존 내용 유지 + 소량 보완)

- 기존 명세의 엔드포인트/파라미터 설명은 유지
- 추가 안내:
  - 무료 API이며, **키가 필요 없어서 초보자가 설정에 실수할 여지가 적음**
  - 네트워크 오류나 응답 지연이 잦을 수 있으므로,
    - `timeout=5` 정도를 기본으로 사용
    - 1–2회 자동 재시도 후 실패 시에도 **앱 전체가 멈추지 않고 “이미지 없이 텍스트만 진행”**하도록 설계

---

## 5. 이미지 생성 워크플로우 (원본 유지 + 진행상황/오류 처리 강화)

기존 5장 내용은 대부분 그대로 유지하되:

- 각 단계마다 **진행률 바(progress)와 상태 메시지** 업데이트
- Iconify/Material Icons 실패 시, 해당 카드에
  - “아이콘 검색 실패 – 나중에 수동으로 이미지 추가”라는 안내 문구 표시
- 프롬프트 생성 시, 카드 타입에 따라
  - 초보자가 이해하기 쉬운 한글 설명을 우선 넣고
  - AI용 키워드(IMAGE_KEY)는 끝부분에 모아서 나열

---

## 6. 데이터 구조 (기존 유지 + error_log.json 간단 추가)

`error_log.json` 예시:

```json
{
  "errors": [
    {
      "timestamp": "2025-01-01T09:00:00+09:00",
      "module": "summarize_with_gemini",
      "message": "429 quota exceeded",
      "extra": {
        "key_index": 1
      }
    }
  ]
}
```

> 구조를 매우 단순하게 유지해 초보자도 파일을 열어 어떤 오류가 있었는지 바로 이해할 수 있게 합니다.

---

## 7. UI/UX 디자인 (원본 유지 + 초보자용 안내/진행상황 추가)

주요 추가 요소:

- 상단 또는 사이드바에 **“오늘의 사용 흐름”** 박스
  - ① 뉴스 선택 → ② 요약 생성 → ③ 카드뉴스 생성 → ④ 이미지 자료 준비
- 각 버튼 주변에 한 줄씩 **한글 설명 문구**
  - 예: `"원문 요약 생성" 버튼: 기사를 350~450자 한글로 요약합니다. 하루 무료 사용량이 있으니 필요한 기사만 눌러주세요.`
- **진행 상황 표시**
  - Streamlit `st.progress`, `st.status` 등을 사용해
    - “뉴스 검색 중…”, “요약 생성 중…”, “카드뉴스 문구 생성 중…” 등 단계 표시

---

## 8. 스케줄링 시스템 (원본 유지, 무료 전용 가이드 명확화)

- Railway 무료 티어 또는 로컬 PC의 cron/schedule 중 **사용자가 편한 쪽 하나만 선택**해도 충분
- 초보자를 위해:
  - `daily_fetch.py`를 **수동 실행해도 전체 기능은 동작**하도록 설계
  - 자동 스케줄은 “있으면 편하고, 없어도 괜찮은 옵션”으로 위치시킴

---

## 9. 테스트 모드 (원본 유지)

기존 TEST_MODE 동작은 이미 무료 쿼터 절약에 최적화되어 있으므로 유지합니다.  
추가로:

- TEST_MODE일 때는 화면 상단에
  - “테스트 모드: 무료 쿼터를 아끼기 위해 최소한만 생성합니다.” 안내 문구 노출

---

## 10. 배포 및 운영 (무료·초보자 기준 설명 보강)

- 기본 권장:
  - **로컬 실행 + GitHub 백업**만으로도 충분히 운영 가능
  - 매일 데스크톱에서 `python daily_fetch.py` 한 번 실행 → 앱에서 사용
- 클라우드 자동화가 필요할 때만 Railway 무료 티어 사용
  - 사용량이 늘어나면, 비용 발생 전에 **Railway 대시보드에서 크레딧을 수시로 확인**하도록 안내

---

## 11. 에러 처리 및 주의사항 (초보자용 메시지 추가)

- `print()`만 사용하는 대신, 중요한 오류는
  - `error_log.json`에 기록
  - Streamlit 화면에 **한글 안내 + 해결 방법**을 함께 표시
    - 예: “네이버 뉴스 API 호출에 실패했습니다. .env 파일의 NAVER_CLIENT_ID, NAVER_CLIENT_SECRET 값을 다시 확인해주세요.”

---

## 12. 핵심 구현 체크리스트 (개선 반영)

필수 구현 사항은 기존 리스트를 유지하되, 아래 항목을 추가합니다.

- [ ] `setup_checker.py`로 **환경/폴더 자동 점검** 구현
- [ ] `cache/` 기반 **요약/카드뉴스 캐싱 시스템** 구현
- [ ] Streamlit UI에 **진행 상황 표시(Progress Bar)** 추가
- [ ] `data/error_log.json` 기반 **간단 에러 로깅** 구현

권장 구현 사항은 다음을 포함합니다.

- [ ] 간단 통계 대시보드 (일일 기사 수, 요약/카드뉴스 생성 건수, 쿼터 사용량 등)
- [ ] Slack 알림 비사용 시에도, 앱 내에서 “오늘의 추천 기사 5개”를 한눈에 볼 수 있는 섹션

---

## 13. 새로 만들 때 주의할 점 – 13.3 성능 최적화 (개선 핵심)

### 13.3 성능 최적화 (무료/초보자 기준으로 재구성)

1. **API 호출 최소화 (캐싱 필수)**
   - 같은 기사(URL 또는 제목+날짜 조합)에 대해
     - 요약, 카드뉴스 문구를 **최초 1회만 생성**하고
     - 이후에는 `cache/` 폴더에서 재사용
   - 캐시 키 예시:
     - `cache/summary_{hash}.txt`
     - `cache/card_script_{hash}.txt`
   - 이로 인해:
     - 무료 Gemini 쿼터 사용량을 크게 줄이고
     - 응답 속도도 빨라짐

2. **비동기 처리(선택)보다 “단순한 배치 처리 + 진행상황 표시” 우선**
   - 초보자 친화성을 위해 복잡한 `async/await` 대신,
     - 기사 N개를 **작은 묶음(batch)** 단위로 순차 처리
     - 각 단계마다 UI에 남은 개수/진행률을 보여주어 “멈춘 것처럼 보이지 않도록” 설계

3. **배치 처리 전략**
   - 예: 하루에 10개 기사를 추천하더라도
     - 기본 설정은 **상위 3개만 요약/카드뉴스 자동 생성**
     - 나머지는 사용자가 필요할 때 버튼을 눌러 개별 생성
   - 이렇게 하면,
     - 실제 사용하는 기사에만 쿼터를 집중할 수 있어 **효율성이 크게 향상**

4. **네트워크 요청 타임아웃·재시도 정책**
   - Iconify, Naver, Gemini 호출 시
     - `timeout`을 명시하고 (예: 5~10초)
     - 실패 시 1–2회만 재시도 후, 실패 메시지와 함께 **다음 작업으로 넘어감**
   - 전체 시스템이 외부 API 한 번 때문에 멈추지 않도록 보장

5. **데이터 파일 크기 관리**
   - `history.json`, `error_log.json`이 너무 커지면
     - 오래된 레코드를 주기적으로 잘라내거나
     - 월별 파일로 분리 (예: `history_2025_01.json`)
   - 이 작업은 별도 스크립트(`maintenance.py`)로 만들어  
     초보자가 “월 1회 실행” 정도만 해주면 되도록 단순화

---

## 단계별 진행 방향 (실제 구현 로드맵)

1. **1단계 – 기본 앱 구조 재생성**
   - 기존 `PROJECT_COMPLETE_SPECIFICATION.md`를 참고해
     - `app.py`, `daily_fetch.py`, `history_manager.py` 등의 기본 골격을 먼저 만듭니다.
   - 이때부터는 이 `PROJECT_COMPLETE_SPECIFICATION_v2.md`를 기준으로,
     - `setup_checker.py`, `cache_manager.py` 파일도 함께 생성합니다.

2. **2단계 – 뉴스 검색/요약/카드뉴스 기능 완성**
   - Naver 뉴스 검색 → Gemini 요약 → Gemini 카드뉴스 생성까지 한 번에 흐름이 이어지도록 구현
   - TEST_MODE에서 1개 기사만 처리하는 로직을 먼저 완성해,  
     **무료 쿼터를 낭비하지 않도록** 합니다.

3. **3단계 – 캐싱 및 쿼터 관리 적용**
   - `cache/` 폴더를 만들고,
     - 기사별 요약/카드뉴스를 파일로 저장·재사용하는 기능 구현
   - `gemini_quota.json`을 사용해 키별 사용량과 경고/초과 상태를 관리합니다.

4. **4단계 – 이미지 자료 준비 및 ZIP 다운로드**
   - Iconify/Material Icons 검색, SVG 다운로드, AI 프롬프트 생성, ZIP 묶기까지 구현
   - 네트워크 오류 시에도 앱 전체가 죽지 않도록 `try-except`와 재시도 로직을 추가합니다.

5. **5단계 – UI/UX 다듬기**
   - 진행 상황(progress bar), 상태 메시지, 한글 도움말을 추가해  
     **초보자가 “지금 뭐가 되고 있는지” 항상 알 수 있게** 만듭니다.
   - 쿼터 현황, 오늘 처리한 기사 수, 최근 에러 요약 등을 사이드바에 배치합니다.

6. **6단계 – 스케줄링/알림/통계 등 운영 기능**
   - 필요하다면 Railway나 로컬 cron으로 `daily_fetch.py` 자동 실행을 설정합니다.
   - Slack 알림, 간단 통계 대시보드 등을 추가합니다.

7. **7단계 – 유지보수·최적화**
   - `error_log.json`과 통계를 보면서,
     - 자주 실패하는 부분의 에러 메시지를 더 친절하게 바꾸고
     - 캐시 전략/배치 크기를 조정해 **무료 쿼터를 최대한 효율적으로 활용**합니다.

이 v2 명세서를 기준으로 구현을 진행하면,  
**완전 무료 + 초보자 친화 + 효율성 최적화**라는 세 가지 목표를 모두 만족하는 방향으로 개발을 이어갈 수 있습니다.



